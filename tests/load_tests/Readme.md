# Load testing

## Install locust

```
pip install locust
```
or using Poetry
```
poetry run pip install locust
```

## Run test

In source file `locust_suggestions_by_category.py` time between requests per user is defined as random number between 1 and 5:
```python
class WebsiteUser(HttpUser):
    wait_time = between(1, 5)
```

Run test with maximum number of 20 users, new user spawning rate 0.1 per second.

```
poetry run locust -f locust_suggestions_by_category.py --users 20 --spawn-rate 0.1 --autostart -t 5m -H "http://54.89.196.85"
```

## Tests

### 1 --users 20 --spawn-rate 0.1

```
Type     Name                                                                          # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|----------------------------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
POST     suggestions_by_category                                                          979    33(3.37%) |   1212       3    6806    980 |    3.27        0.11
--------|----------------------------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                                       979    33(3.37%) |   1212       3    6806    980 |    3.27        0.11

Response time percentiles (approximated)
Type     Name                                                                                  50%    66%    75%    80%    90%    95%    98%    99%  99.9% 99.99%   100% # reqs
--------|--------------------------------------------------------------------------------|--------|------|------|------|------|------|------|------|------|------|------|------
POST     suggestions_by_category                                                               980   1400   1700   1900   2500   3000   3400   3700   6800   6800   6800    979
--------|--------------------------------------------------------------------------------|--------|------|------|------|------|------|------|------|------|------|------|------
         Aggregated                                                                            980   1400   1700   1900   2500   3000   3400   3700   6800   6800   6800    979

Error report
# occurrences      Error                                                                                               
------------------|---------------------------------------------------------------------------------------------------------------------------------------------
10                 POST suggestions_by_category: RemoteDisconnected('Remote end closed connection without response')   
19                 POST suggestions_by_category: HTTPError('503 Server Error: Service Unavailable for url: suggestions_by_category')
4                  POST suggestions_by_category: ConnectionResetError(104, 'Connection reset by peer')                 
------------------|---------------------------------------------------------------------------------------------------------------------------------------------
```

From 7 users failures start showing up.

### 2 --users 8 --spawn-rate 1

```
Type     Name                                                                          # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|----------------------------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
POST     suggestions_by_category                                                          654    16(2.45%) |    646      20    2303    480 |    2.18        0.05
--------|----------------------------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                                       654    16(2.45%) |    646      20    2303    480 |    2.18        0.05

Response time percentiles (approximated)
Type     Name                                                                                  50%    66%    75%    80%    90%    95%    98%    99%  99.9% 99.99%   100% # reqs
--------|--------------------------------------------------------------------------------|--------|------|------|------|------|------|------|------|------|------|------|------
POST     suggestions_by_category                                                               480    690    840   1000   1300   1500   1700   1800   2300   2300   2300    654
--------|--------------------------------------------------------------------------------|--------|------|------|------|------|------|------|------|------|------|------|------
         Aggregated                                                                            480    690    840   1000   1300   1500   1700   1800   2300   2300   2300    654

Error report
# occurrences      Error                                                                                               
------------------|---------------------------------------------------------------------------------------------------------------------------------------------
8                  POST suggestions_by_category: HTTPError('503 Server Error: Service Unavailable for url: suggestions_by_category')
8                  POST suggestions_by_category: RemoteDisconnected('Remote end closed connection without response')   
------------------|---------------------------------------------------------------------------------------------------------------------------------------------
```

### 3 --users 6 --spawn-rate 1
```
Type     Name                                                                          # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|----------------------------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
POST     suggestions_by_category                                                          492    21(4.27%) |    592       2    2650    470 |    1.64        0.07
--------|----------------------------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                                       492    21(4.27%) |    592       2    2650    470 |    1.64        0.07

Response time percentiles (approximated)
Type     Name                                                                                  50%    66%    75%    80%    90%    95%    98%    99%  99.9% 99.99%   100% # reqs
--------|--------------------------------------------------------------------------------|--------|------|------|------|------|------|------|------|------|------|------|------
POST     suggestions_by_category                                                               470    630    730    800   1100   1300   1700   2000   2700   2700   2700    492
--------|--------------------------------------------------------------------------------|--------|------|------|------|------|------|------|------|------|------|------|------
         Aggregated                                                                            470    630    730    800   1100   1300   1700   2000   2700   2700   2700    492

Error report
# occurrences      Error                                                                                               
------------------|---------------------------------------------------------------------------------------------------------------------------------------------
6                  POST suggestions_by_category: HTTPError('503 Server Error: Service Unavailable for url: suggestions_by_category')
1                  POST suggestions_by_category: ConnectionResetError(104, 'Connection reset by peer')                 
14                 POST suggestions_by_category: RemoteDisconnected('Remote end closed connection without response')   
------------------|---------------------------------------------------------------------------------------------------------------------------------------------
```

### 34 --users 4 --spawn-rate 1

```
Type     Name                                                                          # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|----------------------------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
POST     suggestions_by_category                                                          342     8(2.34%) |    510       2    1945    430 |    1.14        0.03
--------|----------------------------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                                       342     8(2.34%) |    510       2    1945    430 |    1.14        0.03

Response time percentiles (approximated)
Type     Name                                                                                  50%    66%    75%    80%    90%    95%    98%    99%  99.9% 99.99%   100% # reqs
--------|--------------------------------------------------------------------------------|--------|------|------|------|------|------|------|------|------|------|------|------
POST     suggestions_by_category                                                               430    520    620    670    970   1200   1300   1400   1900   1900   1900    342
--------|--------------------------------------------------------------------------------|--------|------|------|------|------|------|------|------|------|------|------|------
         Aggregated                                                                            430    520    620    670    970   1200   1300   1400   1900   1900   1900    342

Error report
# occurrences      Error                                                                                               
------------------|---------------------------------------------------------------------------------------------------------------------------------------------
8                  POST suggestions_by_category: RemoteDisconnected('Remote end closed connection without response')   
------------------|---------------------------------------------------------------------------------------------------------------------------------------------

```

### 5 --users 2 --spawn-rate 1
```
Type     Name                                                                          # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|----------------------------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
POST     suggestions_by_category                                                          173     4(2.31%) |    502     243    1498    410 |    0.58        0.01
--------|----------------------------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                                       173     4(2.31%) |    502     243    1498    410 |    0.58        0.01

Response time percentiles (approximated)
Type     Name                                                                                  50%    66%    75%    80%    90%    95%    98%    99%  99.9% 99.99%   100% # reqs
--------|--------------------------------------------------------------------------------|--------|------|------|------|------|------|------|------|------|------|------|------
POST     suggestions_by_category                                                               410    480    600    670    960   1200   1400   1500   1500   1500   1500    173
--------|--------------------------------------------------------------------------------|--------|------|------|------|------|------|------|------|------|------|------|------
         Aggregated                                                                            410    480    600    670    960   1200   1400   1500   1500   1500   1500    173

Error report
# occurrences      Error                                                                                               
------------------|---------------------------------------------------------------------------------------------------------------------------------------------
4                  POST suggestions_by_category: HTTPError('503 Server Error: Service Unavailable for url: suggestions_by_category')
------------------|---------------------------------------------------------------------------------------------------------------------------------------------
```

```commandline
Type     Name                                                                          # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|----------------------------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
POST     suggestions_by_category                                                           76     3(3.95%) |    981      57   36450    430 |    0.25        0.01
--------|----------------------------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                                        76     3(3.95%) |    981      57   36450    430 |    0.25        0.01

Response time percentiles (approximated)
Type     Name                                                                                  50%    66%    75%    80%    90%    95%    98%    99%  99.9% 99.99%   100% # reqs
--------|--------------------------------------------------------------------------------|--------|------|------|------|------|------|------|------|------|------|------|------
POST     suggestions_by_category                                                               440    550    640    720   1200   1300   1400  36000  36000  36000  36000     76
--------|--------------------------------------------------------------------------------|--------|------|------|------|------|------|------|------|------|------|------|------
         Aggregated                                                                            440    550    640    720   1200   1300   1400  36000  36000  36000  36000     76

Error report
# occurrences      Error                                                                                               
------------------|---------------------------------------------------------------------------------------------------------------------------------------------
3                  POST suggestions_by_category: RemoteDisconnected('Remote end closed connection without response')   
------------------|---------------------------------------------------------------------------------------------------------------------------------------------
```


5GB zajęte
workers:
- default 5 GB
- 2 9 GB
- 4 13 GB
- 8 31 GB? crash

bash run_tests.sh > log 2>&1

curl -F 'sprunge=<-' http://sprunge.us < log


poetry run gunicorn web_api:app --workers 1 --worker-class uvicorn.workers.UvicornWorker --timeout 120

Memory worker (VIRT, RES):
- uvicorn 1: 5,5GB 4GB  14.8-11=3.8 GB
- uvicorn 2: 2x 5,5GB 4GB 18.7-11=7.7 GB
- gunicorn 1 worker sync: 15.1-11.3=3.8 GB
- gunicorn 2 worker sync: 19.1-11.4=7.7 GB
- gunicorn 2 worker uvicorn with preload: 15.6-11.7 = 3.9 GB
- gunicorn 4 worker uvicorn with preload: 4 GB